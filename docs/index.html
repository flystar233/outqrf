<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Find the Outlier by Quantile Random Forests • outqrf</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Find the Outlier by Quantile Random Forests">
<meta name="description" content="Provides a method to find the outlier in custom data by quantile random forests method. Introduced by Meinshausen Nicolai (2006) &lt;doi:10.5555/1248547.1248582&gt;. It directly calls the ranger() function of the ranger package to perform data fitting and prediction. We also implement the evaluation of outlier prediction results. Compared with random forest detection of outliers, this method has higher accuracy and stability on large datasets.">
<meta property="og:description" content="Provides a method to find the outlier in custom data by quantile random forests method. Introduced by Meinshausen Nicolai (2006) &lt;doi:10.5555/1248547.1248582&gt;. It directly calls the ranger() function of the ranger package to perform data fitting and prediction. We also implement the evaluation of outlier prediction results. Compared with random forest detection of outliers, this method has higher accuracy and stability on large datasets.">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">outqrf</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="articles/outqrf.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/flystar233/outqrf/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header"><h1 id="outqrf">{outqrf}<a class="anchor" aria-label="anchor" href="#outqrf"></a>
</h1></div>
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p><strong>outqrf</strong> is an R package used for outlier detection. Each numeric variable is regressed onto all other variables using a quantile random forest (QRF). We use <a href="https://github.com/imbs-hl/ranger" class="external-link">ranger</a> to perform the fitting and prediction of quantile regression forests (QRF). Next, we will compute the rank of the observed values in the predicted results’ quantiles. If the rank of the observed value exceeds the threshold, the observed value is considered an outlier.</p>
<p>Since the same predicted value might be distributed across multiple quantiles in the predicted quantile results, this affects our location finding for the observed value. Therefore, we also used a method similar to the <a href="https://github.com/mayer79/outForest" class="external-link">outForest</a> package to compare the observed value with the 50% quantile value again to determine the final quantile result.</p>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Development version</span></span>
<span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"flystar233/outqrf"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="usage">Usage<a class="anchor" aria-label="anchor" href="#usage"></a>
</h2>
<p>We first generate a data set with about 5% outliers values in each numeric column.</p>
<pre><code><span><span class="co">#Generate data with outliers in numeric columns</span></span>
<span><span class="va">irisWithOutliers</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/generateOutliers.html">generateOutliers</a></span><span class="op">(</span><span class="va">iris</span>, p <span class="op">=</span> <span class="fl">0.05</span>,seed <span class="op">=</span><span class="fl">2024</span><span class="op">)</span></span>
<span><span class="co"># Find outliers by quantile random forest regressions</span></span>
<span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/outqrf.html">outqrf</a></span><span class="op">(</span><span class="va">irisWithOutliers</span>,quantiles_type<span class="op">=</span><span class="fl">400</span><span class="op">)</span></span>
<span><span class="va">out</span><span class="op">$</span><span class="va">outliers</span></span>
<span><span class="co">#    row          col    observed predicted  rank</span></span>
<span><span class="co"># 1   32 Sepal.Length  14.9308229       5.4 0.999</span></span>
<span><span class="co"># 2   35 Sepal.Length  -1.8135664       4.6 0.001</span></span>
<span><span class="co"># 3   84 Sepal.Length  11.4849203       6.3 0.999</span></span>
<span><span class="co"># 4  129 Sepal.Length  -5.6021049       6.2 0.001</span></span>
<span><span class="co"># 5   49  Sepal.Width  10.7927619       3.7 0.999</span></span>
<span><span class="co"># 6   90  Sepal.Width  -0.7648333       2.4 0.001</span></span>
<span><span class="co"># 7  131  Sepal.Width  -2.1389311       2.7 0.001</span></span>
<span><span class="co"># 8  137  Sepal.Width  11.4992802       3.2 0.999</span></span>
<span><span class="co"># 9   36 Petal.Length  12.8033669       1.6 0.999</span></span>
<span><span class="co"># 10  73 Petal.Length -17.1905846       4.4 0.001</span></span>
<span><span class="co"># 11 107 Petal.Length  13.6672827       5.6 0.999</span></span>
<span><span class="co"># 12 123 Petal.Length  -8.9717894       5.1 0.001</span></span>
<span><span class="co"># 13 140 Petal.Length  13.5214560       5.7 0.999</span></span>
<span><span class="co"># 14  10  Petal.Width -11.8406790       0.2 0.001</span></span>
<span><span class="co"># 15  14  Petal.Width  -6.3030372       0.2 0.003</span></span>
<span><span class="co"># 16  34  Petal.Width   7.5843853       0.4 0.999</span></span>
<span><span class="co"># 17  66  Petal.Width   6.9828746       2.0 0.993</span></span>
<span><span class="co"># 18 113  Petal.Width  -6.0696862       1.5 0.001</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="evaluation-on-iris-small-dataset">Evaluation on iris (Small Dataset)<a class="anchor" aria-label="anchor" href="#evaluation-on-iris-small-dataset"></a>
</h2>
<p>First, let’s simply detect outliers in the data using a box plot.</p>
<pre><code><span><span class="co"># find outliers use boxplot</span></span>
<span><span class="co"># 32</span></span>
<span><span class="va">irisWithOutliers</span> <span class="op">&lt;-</span> <span class="fu">outqrf</span><span class="fu">::</span><span class="fu"><a href="reference/generateOutliers.html">generateOutliers</a></span><span class="op">(</span><span class="va">iris</span>, p <span class="op">=</span> <span class="fl">0.05</span>,seed <span class="op">=</span><span class="fl">2024</span><span class="op">)</span></span>
<span><span class="va">boxplot_num</span> <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">irisWithOutliers</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">irisWithOutliers</span>,<span class="va">is.numeric</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">q1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">irisWithOutliers</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span>, <span class="fl">0.25</span><span class="op">)</span></span>
<span>  <span class="va">q3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">irisWithOutliers</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span>, <span class="fl">0.75</span><span class="op">)</span></span>
<span>  <span class="va">iqr</span> <span class="op">&lt;-</span> <span class="va">q3</span> <span class="op">-</span> <span class="va">q1</span></span>
<span>  <span class="va">lower_bound</span> <span class="op">&lt;-</span> <span class="va">q1</span> <span class="op">-</span> <span class="fl">1.5</span> <span class="op">*</span> <span class="va">iqr</span></span>
<span>  <span class="va">upper_bound</span> <span class="op">&lt;-</span> <span class="va">q3</span> <span class="op">+</span> <span class="fl">1.5</span> <span class="op">*</span> <span class="va">iqr</span></span>
<span>  <span class="va">num</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">irisWithOutliers</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span><span class="op">&lt;</span><span class="va">lower_bound</span><span class="op">|</span><span class="va">irisWithOutliers</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span><span class="op">&gt;</span><span class="va">upper_bound</span><span class="op">)</span></span>
<span>  <span class="va">boxplot_num</span><span class="op">&lt;-</span><span class="va">boxplot_num</span><span class="op">+</span><span class="va">num</span></span>
<span><span class="op">}</span></span>
<span><span class="va">boxplot_num</span></span>
<span><span class="co"># 28</span></span></code></pre>
<p><img src="https://github.com/user-attachments/assets/0a453eb9-3901-4c46-a4f4-ee86c386a701"></p>
<p>Then, use outqtf and outForest respectively to detect outliers.</p>
<pre><code><span><span class="va">qrf</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/outqrf.html">outqrf</a></span><span class="op">(</span><span class="va">irisWithOutliers</span>,quantiles_type<span class="op">=</span><span class="fl">400</span><span class="op">)</span></span>
<span><span class="va">rf</span> <span class="op">&lt;-</span> <span class="fu">outForest</span><span class="op">(</span><span class="va">irisWithOutliers</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="reference/evaluateOutliers.html">evaluateOutliers</a></span><span class="op">(</span><span class="va">iris</span>,<span class="va">irisWithOutliers</span>,<span class="va">qrf</span><span class="op">$</span><span class="va">outliers</span><span class="op">)</span></span>
<span><span class="co">#Actual  Predicted      Cover   Coverage Efficiency</span></span>
<span><span class="co"># 32.00      17.00      17.00       0.53       1.00</span></span>
<span><span class="fu"><a href="reference/evaluateOutliers.html">evaluateOutliers</a></span><span class="op">(</span><span class="va">iris</span>,<span class="va">irisWithOutliers</span>,<span class="va">rf</span><span class="op">$</span><span class="va">outliers</span><span class="op">)</span></span>
<span><span class="co">#Actual  Predicted      Cover   Coverage Efficiency</span></span>
<span><span class="co"># 32.00      19.00      19.00       0.59       1.00 </span></span></code></pre>
<p>We can even display the original values and outliers of the data using a paired box plot.</p>
<pre><code><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">qrf</span><span class="op">)</span></span></code></pre>
<p><img src="https://github.com/user-attachments/assets/073f4e4d-3c80-459a-af50-40988d769899"></p>
</div>
<div class="section level2">
<h2 id="evaluation-on-diamonds-big-dataset">Evaluation on diamonds (Big Dataset)<a class="anchor" aria-label="anchor" href="#evaluation-on-diamonds-big-dataset"></a>
</h2>
<pre><code><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">diamonds</span><span class="op">|&gt;</span><span class="fu">select</span><span class="op">(</span><span class="va">price</span>,<span class="va">carat</span>,<span class="va">cut</span>,<span class="va">color</span>,<span class="va">clarity</span><span class="op">)</span></span>
<span><span class="va">data2</span> <span class="op">&lt;-</span> <span class="fu">outqrf</span><span class="fu">::</span><span class="fu"><a href="reference/generateOutliers.html">generateOutliers</a></span><span class="op">(</span><span class="va">data</span>, p <span class="op">=</span> <span class="fl">0.001</span>,seed <span class="op">=</span><span class="fl">2024</span><span class="op">)</span></span>
<span><span class="va">qrf</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/outqrf.html">outqrf</a></span><span class="op">(</span><span class="va">data2</span>,num.threads<span class="op">=</span><span class="fl">8</span>,quantiles_type<span class="op">=</span><span class="fl">400</span><span class="op">)</span></span>
<span><span class="co"># The process can be slow because it needs to predict the value at 400|1000 quantiles for each observation.</span></span>
<span><span class="va">rf</span> <span class="op">&lt;-</span> <span class="fu">outForest</span><span class="op">(</span><span class="va">data2</span><span class="op">)</span></span>
<span><span class="fu"><a href="reference/evaluateOutliers.html">evaluateOutliers</a></span><span class="op">(</span><span class="va">data</span>,<span class="va">data2</span>,<span class="va">qrf</span><span class="op">$</span><span class="va">outliers</span><span class="op">)</span></span>
<span><span class="co">#Actual  Predicted      Cover   Coverage Efficiency</span></span>
<span><span class="co">#108.00     369.00     103.00       0.95       0.28</span></span>
<span><span class="fu"><a href="reference/evaluateOutliers.html">evaluateOutliers</a></span><span class="op">(</span><span class="va">data</span>,<span class="va">data2</span>,<span class="va">rf</span><span class="op">$</span><span class="va">outliers</span><span class="op">)</span></span>
<span><span class="co">#Actual  Predicted      Cover   Coverage Efficiency</span></span>
<span><span class="co">#108.00     687.00     104.00       0.96       0.15</span></span></code></pre>
</div>
</div>
  </main><aside class="col-md-3"><div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/flystar233/outqrf/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/flystar233/outqrf/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing outqrf</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Tengfei Xu <br><small class="roles"> Author, maintainer </small>  </li>
</ul>
</div>



  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Tengfei Xu.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
